<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู | AuraPrice</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>
                    <span class="logo-icon">โฆ</span>
                    AuraPrice
                </h2>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <span class="nav-icon">๐</span>
                    <span>ููุญุฉ ุงูุชุญูู</span>
                </a>
                <a href="products.html" class="nav-item">
                    <span class="nav-icon">๐</span>
                    <span>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</span>
                </a>
                <a href="pricing.html" class="nav-item">
                    <span class="nav-icon">๐ฐ</span>
                    <span>ุฅุนุฏุงุฏุงุช ุงูุชุณุนูุฑ</span>
                </a>
                <a href="salla-integration.html" class="nav-item">
                    <span class="nav-icon">๐</span>
                    <span>ุฑุจุท ููุตุฉ ุณูุฉ</span>
                </a>
                <a href="automation.html" class="nav-item">
                    <span class="nav-icon">โก</span>
                    <span>ุงูุชุญุฏูุซ ุงูุชููุงุฆู</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <span class="nav-icon">๐</span>
                    <span>ุงูุชูุงุฑูุฑ</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="nav-icon">โ๏ธ</span>
                    <span>ุงูุฅุนุฏุงุฏุงุช</span>
                </a>
                <a href="index.html" class="nav-item" style="margin-top: 2rem; color: #EF4444;">
                    <span class="nav-icon">๐ช</span>
                    <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-title">
                    <h1>ูุฑุญุจูุง ุจูุ ุฃุณุงูุฉ ๐</h1>
                    <p>ุฅููู ูุธุฑุฉ ุนุงูุฉ ุนูู ูุดุงุท ูุชุฌุฑู ุงูููู</p>
                </div>
                <div class="header-actions">
                    <div class="gold-prices-ticker">
                        <div class="price-ticker-item">
                            <span class="ticker-label">ุนูุงุฑ 24</span>
                            <span class="ticker-price" id="ticker-24k">--</span>
                        </div>
                        <div class="price-ticker-item">
                            <span class="ticker-label">ุนูุงุฑ 22</span>
                            <span class="ticker-price" id="ticker-22k">--</span>
                        </div>
                        <div class="price-ticker-item main">
                            <span class="ticker-label">ุนูุงุฑ 21</span>
                            <span class="ticker-price" id="ticker-21k">--</span>
                            <span class="price-change" id="ticker-change">--</span>
                        </div>
                        <div class="price-ticker-item">
                            <span class="ticker-label">ุนูุงุฑ 18</span>
                            <span class="ticker-price" id="ticker-18k">--</span>
                        </div>
                        <div class="price-ticker-item">
                            <span class="ticker-label">ุนูุงุฑ 14</span>
                            <span class="ticker-price" id="ticker-14k">--</span>
                        </div>
                        <div class="price-ticker-item silver">
                            <span class="ticker-label">ุงููุถุฉ</span>
                            <span class="ticker-price" id="ticker-silver">--</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Stats Grid -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
                        <div class="stat-icon gold">๐</div>
                    </div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-footer">
                        <span class="stat-badge success">ูุฒุงููุฉ</span>
                        <span>ูู ูุชุฌุฑ ุณูุฉ</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">ุงูููุชุฌุงุช ุงููุดุทุฉ</span>
                        <div class="stat-icon blue">โ</div>
                    </div>
                    <div class="stat-value" id="activeProducts">0</div>
                    <div class="stat-footer">
                        <span class="stat-badge success" id="activePercent">0%</span>
                        <span>ูู ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">ุขุฎุฑ ูุฒุงููุฉ</span>
                        <div class="stat-icon green">โก</div>
                    </div>
                    <div class="stat-value" id="lastSync" style="font-size: 1.2rem;">-</div>
                    <div class="stat-footer">
                        <span class="stat-badge success">ูุฑุจูุท</span>
                        <span>ุจููุตุฉ ุณูุฉ</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">ุญุงูุฉ ุงูุงุชุตุงู</span>
                        <div class="stat-icon gold">๐</div>
                    </div>
                    <div class="stat-value" id="connectionStatus" style="font-size: 1.2rem;">ุฌุงุฑู ุงููุญุต...</div>
                    <div class="stat-footer">
                        <span class="stat-badge" id="connectionBadge">-</span>
                        <span>ุงูุณูุฑูุฑ</span>
                    </div>
                </div>
            </section>

            <!-- Quick Actions & Recent Activity -->
            <div class="content-grid">
                <!-- Quick Actions -->
                <section class="quick-actions-card">
                    <h3 class="section-title">ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</h3>
                    <div class="actions-grid">
                        <button class="action-btn gold">
                            <span class="action-icon">โก</span>
                            <div class="action-content">
                                <h4>ุชุญุฏูุซ ุงูุฃุณุนุงุฑ ุงูุขู</h4>
                                <p>ุชุญุฏูุซ ุฌููุน ุงูููุชุฌุงุช ุจุณุนุฑ ุงูุฐูุจ ุงูุญุงูู</p>
                            </div>
                        </button>

                        <button class="action-btn blue">
                            <span class="action-icon">๐</span>
                            <div class="action-content">
                                <h4>ูุฒุงููุฉ ูุน ุณูุฉ</h4>
                                <p>ุณุญุจ ุงูููุชุฌุงุช ุงูุฌุฏูุฏุฉ ูู ูุชุฌุฑู</p>
                            </div>
                        </button>

                        <button class="action-btn green">
                            <span class="action-icon">๐ฅ</span>
                            <div class="action-content">
                                <h4>ุงุณุชูุฑุงุฏ ููุชุฌุงุช</h4>
                                <p>ุฑูุน ููู Excel ุฃู CSV</p>
                            </div>
                        </button>

                        <button class="action-btn purple">
                            <span class="action-icon">๐</span>
                            <div class="action-content">
                                <h4>ุชุตุฏูุฑ ุชูุฑูุฑ</h4>
                                <p>ุชุญููู ุชูุฑูุฑ ุดุงูู ุจุงูุฃุณุนุงุฑ</p>
                            </div>
                        </button>
                    </div>
                </section>

                <!-- Price History Chart -->
                <section class="chart-card">
                    <div class="chart-header">
                        <h3 class="section-title">ุชุงุฑูุฎ ุฃุณุนุงุฑ ุงูุฐูุจ</h3>
                        <div class="chart-tabs">
                            <button class="chart-tab active">ุงูููู</button>
                            <button class="chart-tab">ุฃุณุจูุน</button>
                            <button class="chart-tab">ุดูุฑ</button>
                        </div>
                    </div>
                    <div class="chart-placeholder">
                        <div class="chart-line">
                            <svg viewBox="0 0 400 150" width="100%" height="150">
                                <path d="M 0 100 L 50 90 L 100 85 L 150 75 L 200 80 L 250 70 L 300 65 L 350 60 L 400 55"
                                      stroke="url(#chartGradient)" stroke-width="3" fill="none"/>
                                <defs>
                                    <linearGradient id="chartGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#FFB800;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#FFC837;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="chart-stats">
                            <div class="chart-stat">
                                <span class="chart-stat-label">ุงูุญุฏ ุงูุฃุฏูู</span>
                                <span class="chart-stat-value" id="chart-min">-- ุฑ.ุณ</span>
                            </div>
                            <div class="chart-stat">
                                <span class="chart-stat-label">ุงูุญุฏ ุงูุฃูุตู</span>
                                <span class="chart-stat-value" id="chart-max">-- ุฑ.ุณ</span>
                            </div>
                            <div class="chart-stat">
                                <span class="chart-stat-label">ุงูุณุนุฑ ุงูุญุงูู</span>
                                <span class="chart-stat-value" id="chart-current">-- ุฑ.ุณ</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Recent Updates -->
            <section class="recent-updates-card">
                <h3 class="section-title">ุขุฎุฑ ุงูุชุญุฏูุซุงุช</h3>
                <div class="updates-list" id="updatesList">
                    <div class="update-item" style="text-align: center; padding: 2rem;">
                        <p style="color: #888;">ูุง ุชูุฌุฏ ุชุญุฏูุซุงุช ุจุนุฏ</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        const API_URL = "https://aura-backend-vdqi.onrender.com";
        const CARAT_MULTIPLIERS = { '24': 1, '22': 0.9167, '21': 0.875, '18': 0.75, '14': 0.583 };

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            checkConnection();
            loadUpdates();
            fetchLiveGoldPrice();
            fetchLiveSilverPrice();
        });

        // ===== ุฌูุจ ุณุนุฑ ุงูุฐูุจ ุงูุญู =====
        async function fetchLiveGoldPrice() {
            // ุนุฑุถ ุขุฎุฑ ุณุนุฑ ูุญููุธ ููุฑุงู ุฃุซูุงุก ุงูุฌูุจ
            const savedPrice = localStorage.getItem('aura_gold_price');
            if (savedPrice) {
                updateGoldTicker(parseFloat(savedPrice));
            }

            try {
                const res = await fetch(`${API_URL}/api/gold-price`);
                const data = await res.json();
                let price24k = 0;

                if (data.price_gram_24k) {
                    price24k = data.price_gram_24k;
                } else if (data.price) {
                    price24k = data.price / 31.1035;
                }

                if (price24k > 0) {
                    // ุญูุธ ุงูุณุนุฑ
                    localStorage.setItem('aura_gold_price', price24k);
                    localStorage.setItem('aura_gold_price_time', new Date().toISOString());

                    // ุญูุธ ูู ุณุฌู ุงูุฃุณุนุงุฑ
                    savePriceHistory(price24k);

                    // ุชุญุฏูุซ ุงูุนุฑุถ
                    updateGoldTicker(price24k);
                    updateChartStats(price24k);
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุฌูุจ ุณุนุฑ ุงูุฐูุจ:', error);
            }
        }

        // ===== ุฌูุจ ุณุนุฑ ุงููุถุฉ =====
        async function fetchLiveSilverPrice() {
            const savedSilver = localStorage.getItem('aura_silver_price');
            if (savedSilver) {
                const el = document.getElementById('ticker-silver');
                if (el) el.textContent = parseFloat(savedSilver).toFixed(2);
            }

            try {
                const res = await fetch(`${API_URL}/api/silver-price`);
                const data = await res.json();
                let silverPrice = 0;

                if (data.price_gram_24k) {
                    silverPrice = data.price_gram_24k;
                } else if (data.price) {
                    silverPrice = data.price / 31.1035;
                }

                if (silverPrice > 0) {
                    localStorage.setItem('aura_silver_price', silverPrice);
                    const el = document.getElementById('ticker-silver');
                    if (el) el.textContent = silverPrice.toFixed(2);
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุฌูุจ ุณุนุฑ ุงููุถุฉ:', error);
            }
        }

        // ===== ุชุญุฏูุซ ุดุฑูุท ุงูุฃุณุนุงุฑ =====
        function updateGoldTicker(price24k) {
            const prices = {
                '24k': price24k,
                '22k': price24k * CARAT_MULTIPLIERS['22'],
                '21k': price24k * CARAT_MULTIPLIERS['21'],
                '18k': price24k * CARAT_MULTIPLIERS['18'],
                '14k': price24k * CARAT_MULTIPLIERS['14']
            };

            Object.entries(prices).forEach(([key, val]) => {
                const el = document.getElementById(`ticker-${key}`);
                if (el) el.textContent = val.toFixed(2);
            });

            // ุญุณุงุจ ูุณุจุฉ ุงูุชุบูุฑ (ููุงุฑูุฉ ุจุขุฎุฑ ุณุนุฑ ูุณุฌู)
            const history = JSON.parse(localStorage.getItem('aura_price_history') || '[]');
            if (history.length >= 2) {
                const prevPrice = history[history.length - 2].price;
                const changePercent = ((price24k - prevPrice) / prevPrice * 100).toFixed(1);
                const changeEl = document.getElementById('ticker-change');
                if (changeEl) {
                    changeEl.textContent = `${changePercent >= 0 ? 'โ' : 'โ'} ${Math.abs(changePercent)}%`;
                    changeEl.style.color = changePercent >= 0 ? '#10B981' : '#EF4444';
                }
            }
        }

        // ===== ุญูุธ ุณุฌู ุงูุฃุณุนุงุฑ =====
        function savePriceHistory(price24k) {
            const history = JSON.parse(localStorage.getItem('aura_price_history') || '[]');
            const now = new Date();

            // ูุง ูุญูุธ ุฅุฐุง ุขุฎุฑ ุณุฌู ุฃูู ูู ุณุงุนุฉ
            if (history.length > 0) {
                const lastTime = new Date(history[history.length - 1].time);
                if ((now - lastTime) < 3600000) return;
            }

            history.push({ price: price24k, time: now.toISOString() });

            // ูุญุชูุธ ุจุขุฎุฑ 30 ุณุฌู
            if (history.length > 30) history.shift();

            localStorage.setItem('aura_price_history', JSON.stringify(history));
        }

        // ===== ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฑุณู ุงูุจูุงูู =====
        function updateChartStats(currentPrice) {
            const history = JSON.parse(localStorage.getItem('aura_price_history') || '[]');
            const prices = history.map(h => h.price);

            if (prices.length === 0) prices.push(currentPrice);

            const min = Math.min(...prices);
            const max = Math.max(...prices);

            const minEl = document.getElementById('chart-min');
            const maxEl = document.getElementById('chart-max');
            const currentEl = document.getElementById('chart-current');

            if (minEl) minEl.textContent = `${min.toFixed(2)} ุฑ.ุณ`;
            if (maxEl) maxEl.textContent = `${max.toFixed(2)} ุฑ.ุณ`;
            if (currentEl) currentEl.textContent = `${currentPrice.toFixed(2)} ุฑ.ุณ`;
        }

        function loadDashboardData() {
            const savedProducts = localStorage.getItem('aura_products');
            const savedTime = localStorage.getItem('aura_products_time');

            if (savedProducts) {
                const products = JSON.parse(savedProducts);
                const total = products.length;
                const active = products.filter(p => p.status === 'sale' || p.status === 'active').length;
                const percent = total > 0 ? Math.round((active / total) * 100) : 0;

                document.getElementById('totalProducts').textContent = total.toLocaleString('ar-SA');
                document.getElementById('activeProducts').textContent = active.toLocaleString('ar-SA');
                document.getElementById('activePercent').textContent = percent + '%';
            }

            if (savedTime) {
                const time = new Date(savedTime);
                const now = new Date();
                const diffMins = Math.floor((now - time) / 60000);
                let timeText = '';
                if (diffMins < 60) timeText = `ููุฐ ${diffMins} ุฏูููุฉ`;
                else if (diffMins < 1440) timeText = `ููุฐ ${Math.floor(diffMins/60)} ุณุงุนุฉ`;
                else timeText = time.toLocaleDateString('ar-SA');
                document.getElementById('lastSync').textContent = timeText;
            }
        }

        async function checkConnection() {
            try {
                const res = await fetch(`${API_URL}/api/health`);
                const data = await res.json();
                if (data.status === 'ok') {
                    document.getElementById('connectionStatus').textContent = 'ูุชุตู';
                    document.getElementById('connectionStatus').style.color = '#10B981';
                    document.getElementById('connectionBadge').textContent = 'ูุดุท';
                    document.getElementById('connectionBadge').classList.add('success');
                }
            } catch (err) {
                document.getElementById('connectionStatus').textContent = 'ุบูุฑ ูุชุตู';
                document.getElementById('connectionStatus').style.color = '#EF4444';
                document.getElementById('connectionBadge').textContent = 'ุฎุทุฃ';
                document.getElementById('connectionBadge').classList.add('warning');
            }
        }

        function loadUpdates() {
            const history = JSON.parse(localStorage.getItem('aura_sync_history') || '[]');
            const container = document.getElementById('updatesList');

            if (history.length === 0) return;

            container.innerHTML = history.slice(0, 4).map(item => `
                <div class="update-item">
                    <div class="update-icon ${item.status}">${item.status === 'success' ? 'โ' : 'โ๏ธ'}</div>
                    <div class="update-content">
                        <h4>${item.action}</h4>
                        <p>${item.message}</p>
                    </div>
                    <span class="update-time">${formatTime(item.time)}</span>
                </div>
            `).join('');
        }

        function formatTime(timeStr) {
            const time = new Date(timeStr);
            const now = new Date();
            const diffMins = Math.floor((now - time) / 60000);
            if (diffMins < 60) return `ููุฐ ${diffMins} ุฏูููุฉ`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `ููุฐ ${diffHours} ุณุงุนุฉ`;
            return time.toLocaleDateString('ar-SA');
        }
    </script>
</body>
</html>
